{{- if lt hugo.Version "0.146.0" }}
{{- errorf "=> hugo v0.146.0 or greater is required for hugo-PaperMod to build " }}
{{- end -}}

<!DOCTYPE html>
<html lang="{{ site.Language }}" dir="{{ .Language.LanguageDirection | default "auto" }}">

<head>
    {{- partial "head.html" . }}
</head>

<body class="
{{- if (or (ne .Kind `page` ) (eq .Layout `archives`) (eq .Layout `search`)) -}}
{{- print "list" -}}
{{- end -}}
{{- if eq site.Params.defaultTheme `dark` -}}
{{- print " dark" -}}
{{- end -}}
{{- if .IsHome -}}
{{- print " home" -}}
{{- end -}}
" id="top">
    {{- partialCached "header.html" . .Page -}}
    <main class="main">
        {{- block "main" . }}{{ end }}
    </main>
    {{ partialCached "footer.html" . .Layout .Kind (.Param "hideFooter") (.Param "ShowCodeCopyButtons") -}}
    
    {{- if .Store.Get "hasMermaid" }}
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      
      // Определяем тему на основе текущей темы сайта
      const isDark = document.body.classList.contains('dark') || 
                     (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      const theme = isDark ? 'dark' : 'default';
      
      const lightTheme = {
        primaryColor: '#3498db',
        primaryTextColor: '#2c3e50',
        primaryBorderColor: '#2980b9',
        background: '#ffffff',
        secondaryColor: '#ecf0f1',
        tertiaryColor: '#f8f9fa',
        lineColor: '#34495e',
        textColor: '#2c3e50'
      };
      
      const darkTheme = {
        primaryColor: '#3498db',
        primaryTextColor: '#ecf0f1',
        primaryBorderColor: '#5dade2',
        background: '#2c3e50',
        secondaryColor: '#34495e',
        tertiaryColor: '#455a64',
        lineColor: '#95a5a6',
        textColor: '#ecf0f1'
      };

      mermaid.initialize({ 
        startOnLoad: true,
        theme: theme,
        themeVariables: isDark ? darkTheme : lightTheme,
        flowchart: {
          htmlLabels: true,
          curve: 'basis',
          padding: 10
        },
        sequence: {
          diagramMarginX: 50,
          diagramMarginY: 10,
          actorMargin: 50,
          width: 150,
          height: 65,
          boxMargin: 10,
          boxTextMargin: 5,
          noteMargin: 10,
          messageMargin: 35
        },
        gantt: {
          fontSize: 11,
          gridLineStartPadding: 35,
          bottomPadding: 25,
          leftPadding: 75,
          topPadding: 50
        }
      });
      
      // Обновляем диаграммы при переключении темы
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          setTimeout(() => {
            const newIsDark = document.body.classList.contains('dark');
            const newTheme = newIsDark ? 'dark' : 'default';
            const newThemeVars = newIsDark ? darkTheme : lightTheme;
            
            mermaid.initialize({
              theme: newTheme,
              themeVariables: newThemeVars,
              startOnLoad: true
            });
            
            // Перерендериваем все диаграммы
            const diagrams = document.querySelectorAll('.mermaid');
            diagrams.forEach((diagram, index) => {
              const graphDefinition = diagram.textContent;
              diagram.innerHTML = '';
              mermaid.render(`mermaid-${index}`, graphDefinition, (svgCode) => {
                diagram.innerHTML = svgCode;
              });
            });
          }, 100);
        });
      }
    </script>
    {{- end }}
</body>

</html>

